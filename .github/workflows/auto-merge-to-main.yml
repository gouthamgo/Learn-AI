name: Auto Merge to Main

on:
  push:
    branches:
      - '**'  # Triggers on any branch
      - '!main'  # Except main itself

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for all branches

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get branch name
        id: branch
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          echo "name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Branch: $BRANCH_NAME"

      - name: Check if PR exists
        id: check-pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Check if PR already exists for this branch
          PR_DATA=$(gh pr list --head "${{ steps.branch.outputs.name }}" --base main --json number,state --jq '.[0]')

          if [ -z "$PR_DATA" ] || [ "$PR_DATA" == "null" ]; then
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "state=none" >> $GITHUB_OUTPUT
            echo "No existing PR found"
          else
            PR_NUMBER=$(echo "$PR_DATA" | jq -r '.number')
            PR_STATE=$(echo "$PR_DATA" | jq -r '.state')

            echo "exists=true" >> $GITHUB_OUTPUT
            echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "state=$PR_STATE" >> $GITHUB_OUTPUT
            echo "Found PR #$PR_NUMBER with state: $PR_STATE"
          fi

      - name: Check if already merged
        id: check-merged
        if: steps.check-pr.outputs.exists == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_STATE="${{ steps.check-pr.outputs.state }}"

          if [ "$PR_STATE" == "MERGED" ]; then
            echo "âœ… PR #${{ steps.check-pr.outputs.number }} is already merged!"
            echo "merged=true" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "merged=false" >> $GITHUB_OUTPUT
          fi

      - name: Exit if already merged
        if: steps.check-merged.outputs.merged == 'true'
        run: |
          echo "::notice::PR already merged. Nothing to do! âœ…"
          echo "### âœ… Already Merged" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "PR #${{ steps.check-pr.outputs.number }} was already merged." >> $GITHUB_STEP_SUMMARY
          exit 0

      - name: Create Pull Request
        if: steps.check-pr.outputs.exists == 'false'
        id: create-pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Create PR with auto-merge label
          PR_URL=$(gh pr create \
            --title "ðŸš€ Auto-merge: ${{ steps.branch.outputs.name }}" \
            --body "$(cat <<'EOF'
          ## ðŸ¤– Automated Pull Request

          This PR was automatically created by the CI/CD pipeline.

          **Branch:** \`${{ steps.branch.outputs.name }}\`
          **Target:** \`main\`
          **Triggered by:** Push to branch

          ### Changes
          This PR contains all changes from the \`${{ steps.branch.outputs.name }}\` branch.

          ---

          âœ… **Auto-merge is enabled** - This PR will automatically merge after all checks pass.

          ðŸ”„ **Commit:** ${{ github.sha }}
          EOF
          )" \
            --base main \
            --head "${{ steps.branch.outputs.name }}" \
            --label "auto-merge")

          PR_NUMBER=$(echo "$PR_URL" | grep -oP '(?<=/pull/)\d+')
          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "Created PR #$PR_NUMBER"

      - name: Get PR number
        id: pr-number
        if: steps.check-merged.outputs.merged != 'true'
        run: |
          if [ "${{ steps.check-pr.outputs.exists }}" == "true" ]; then
            echo "number=${{ steps.check-pr.outputs.number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ steps.create-pr.outputs.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Wait for checks
        if: steps.check-merged.outputs.merged != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Waiting for CI checks to complete..."
          sleep 10  # Give time for checks to start

          # Wait up to 5 minutes for checks
          TIMEOUT=300
          ELAPSED=0

          while [ $ELAPSED -lt $TIMEOUT ]; do
            # Get PR status
            STATUS=$(gh pr view ${{ steps.pr-number.outputs.number }} --json statusCheckRollup --jq '.statusCheckRollup[].conclusion' 2>/dev/null || echo "")

            # Check if all checks passed or if there are no checks
            if [ -z "$STATUS" ]; then
              echo "No checks found, proceeding with merge"
              break
            fi

            # Check if any check failed
            if echo "$STATUS" | grep -q "FAILURE"; then
              echo "âŒ Some checks failed. Not merging."
              exit 1
            fi

            # Check if all checks passed
            if ! echo "$STATUS" | grep -q "PENDING" && ! echo "$STATUS" | grep -q "IN_PROGRESS"; then
              echo "âœ… All checks passed!"
              break
            fi

            echo "Checks still running... (${ELAPSED}s elapsed)"
            sleep 10
            ELAPSED=$((ELAPSED + 10))
          done

      - name: Auto-merge PR
        if: steps.check-merged.outputs.merged != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Merging PR #${{ steps.pr-number.outputs.number }}..."

          # Check if PR is still open before merging
          PR_STATE=$(gh pr view ${{ steps.pr-number.outputs.number }} --json state --jq '.state')

          if [ "$PR_STATE" == "MERGED" ]; then
            echo "âœ… PR was already merged (possibly manually)"
            exit 0
          elif [ "$PR_STATE" == "CLOSED" ]; then
            echo "âš ï¸ PR was closed without merging"
            exit 1
          fi

          gh pr merge ${{ steps.pr-number.outputs.number }} \
            --merge \
            --delete-branch \
            --subject "âœ… Auto-merge: ${{ steps.branch.outputs.name }} â†’ main" \
            --body "Automatically merged by CI/CD pipeline" \
            || {
              echo "::warning::Failed to merge PR. It may have been manually merged."
              # Check if it was manually merged
              FINAL_STATE=$(gh pr view ${{ steps.pr-number.outputs.number }} --json state --jq '.state')
              if [ "$FINAL_STATE" == "MERGED" ]; then
                echo "âœ… PR was manually merged - that's OK!"
                exit 0
              else
                exit 1
              fi
            }

          echo "âœ… Successfully merged and deleted branch!"

      - name: Summary
        if: always()
        run: |
          echo "### ðŸŽ‰ Auto-Merge Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ steps.branch.outputs.name }}\`" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check-merged.outputs.merged }}" == "true" ]; then
            echo "- **Status:** Already merged âœ…" >> $GITHUB_STEP_SUMMARY
          elif [ -n "${{ steps.pr-number.outputs.number }}" ]; then
            echo "- **PR #:** ${{ steps.pr-number.outputs.number }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Status:** Merged to main âœ…" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status:** Completed" >> $GITHUB_STEP_SUMMARY
          fi
